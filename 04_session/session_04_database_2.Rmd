---
title: "Computational Archaeology"
subtitle: "04 - Database 2"
author: "Martin Hinz"
institute: "Institut für Archäologische Wissenschaften, Universität Bern"
fontsize: 9pt
date: "25/09/19"
output:
  xaringan::moon_reader:
    chakra: "../libs/remark-latest.min.js"
    css: ["../libs/default.css", "../libs/default-fonts.css", "../libs/customize.css"]
    lib_dir: "libs"
    seal: false
    nature:
      beforeInit: "../libs/macros.js"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      fig_caption: yes
      ratio: "16:10"
---
class: title-slide, center, middle
```{r, echo = FALSE}
# https://stackoverflow.com/questions/25646333/code-chunk-font-size-in-rmarkdown-with-knitr-and-latex
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
library(icon)
```

```{r, echo = FALSE, results="asis"}
cat('# ', rmarkdown::metadata$title)
```

```{r, echo = FALSE, results="asis"}
cat('## ', rmarkdown::metadata$subtitle)
```

```{r, echo = FALSE, results="asis"}
cat('### ', rmarkdown::metadata$author)
```

```{r, echo = FALSE, results="asis"}
cat('#### ', rmarkdown::metadata$institute)
```

```{r, echo = FALSE, results="asis"}
cat(rmarkdown::metadata$date)
```

---
## Designing a data model
### Entity - Relationship (ER)

.pull-left[
**Entity:**<sup>\*</sup>   Real-world object, distinguishable from other objects. An entity is described using a set of attributes. 

**Relationship:**<sup>\*</sup>  Association among two or more entities.  E.g., a fibula was found at Münsingen.
- relationships can have their own attributes.
]

.pull-right[
```{r echo=FALSE, message=F}
library(DiagrammeR)
my_dia <- DiagrammeR::grViz("
digraph models_diagram {
    rankdir='LR';
    graph[overlap=false, splines=true]
    'site' [shape=record, label='{\\
      site|name :string\\l\\
      lat :float\\l\\
      lng :float\\l\\
    }']
    
    'artefact' [shape=record, label='{artefact|\\
      material :string\\l\\
      weight :string\\l\\
    }']
    
    'found_at' [shape=diamond, label='
      found_at\\l\\
      date :datetime
    ']
    

    'site' -> 'found_at' [label='1']
    'found_at' -> 'artefact' [label='N']
}", height=100, width=400)

my_dia
```
]

.footnote[.tiny[<sup>\*</sup>**Entity Set:**  A collection of similar entities.  E.g., all employees.
- All entities in an entity set have the same set of attributes. (Basically)
- Each entity set has a key (!).
- Each attribute has a domain, that means, a range of possible values.

<sup>\*</sup>**Relationship Set:**  Collection of similar relationships.
]]

---
## Types of Relationships

### 1:1, 1:m, n:m

.pull-left[
#### Examples

- potsherds and features (n:m)
  - the sherds of one pot can be found at 1:n features
  - a feature can contain 1:n potsherds
  
- sample and measurements (1:m)
  - 1 sample has 1:n measurements
  
- artefact and find lable (1:1)
  - 1 Artefact has 1 find label
]

.pull-right[
![](../images/03_session/relationships.png)
]
---
## (primary) keys

Each record must be uniquely identifiable.

Primary key!

either
  - a set of attributes that are already there and make the record unique
    - example: Lab Code and Lab Number identify a radiocarbon date

or
 - is an explicit (artificial) attribute that is a sequential number
    - example: an id number from 1...&infin;

**The latter is not pure dogma, but most of the time more pratical**

---
## (primary & foreign) keys

If a record is uniquely identifiable, this can be used in relation to other entities:

.pull-left[
.pull-left[
|sites|
|-----------|
| Münsingen |
| Worb      |

]
.pull-right[
|burials|
|----------|
| Burial 1 |
| Burial 2 |
| Burial 3 |
| Burial 1 |
| Burial 2 |
| Burial 3 |
]
]

.pull-right[
.pull-left[
| id | site      |
|----|-----------|
| 1  | Münsingen |
| 2  | Worb      |
]
.pull-right[
| id | burial   | site_id |
|----|----------|---------|
| 1  | Burial 1 | 1       |
| 2  | Burial 2 | 1       |
| 3  | Burial 3 | 1       |
| 4  | Burial 1 | 2       |
| 5  | Burial 2 | 2       |
| 6  | Burial 3 | 2       |
]
]

The identifier of a record is the **primary key**.

The identifier of another record in relation to this one is the **foreign key**.

---
## Normalisation

> **Database normalization** is the process of structuring a relational database in accordance with a series of so-called normal forms in order **to reduce data redundancy** and **improve data integrity**. -- wikipedia

### 1NF
To satisfy 1NF, the values in each column of a table must be **atomic**. (Meaning one information at the time)

### 2NF
Each data record represents only one fact. If there is data in a table that does not represent only 1 fact, this data is subdivided into individual thematic tables.

or more formal:

It does not have any non-prime attribute that is functionally dependent on any proper subset of any candidate key of the relation. A non-prime attribute of a relation is an attribute that is not a part of any candidate key of the relation.

### 3NF
No data in a record should automatically follow from other data in the same record.

---
## That's enought

There also exists the 4th, 5th and 6th Normal Form (not to mention the Boyce–Codd normal form (BCNF))...

In practise, normalising to the 3th Normal Form is absolutely enough.

> Informally, a relational database relation is often described as "normalized" if it meets third normal form. Most 3NF relations are free of insertion, update, and deletion anomalies. -- wikipedia

Most of that comes naturally if you think about your relations as objects in the 'Real World'<sup>tm</sup>.
---
## Let's get practical

.pull-left[
We want to design a data base for finds of the site Prag-Miškovice.

.tiny[Do not fear, the book is in German!]

What **Informations** do we like to record?

What **Entities** and **Relations** do we have?

What **Attributes** will the **Entities** have?

How can we transform that into tables (this usually comes naturally than)?
]

.pull-right[
![](../images/03_session/miskovice_screenshot.png)
]
---
## Structure MiscoviceDB

```{r echo=FALSE, message=F}
library(DiagrammeR)
my_dia <- DiagrammeR::grViz("
digraph models_diagram {
    rankdir='LR';
    graph[overlap=false, splines=true]
    'sites' [shape=record, label='{\\
      sites|name :string\\l\\
      lat :float\\l\\
      lng :float\\l\\
    }']
    
    'graves' [shape=record, label='{graves|\\
      grave_number :string\\l\\
      depth :float\\l\\
      length :float\\l\\
      width :float\\l\\
      construction :text\\l\\
    }']
    
    'individuals' [shape=record, label='{individuals|\\
      sex :string\\l\\
      age :float\\l\\
      orientation :float\\l\\
      completness :float\\l\\
    }']
    
    'artefacts' [shape=record, label='{artefacts|\\
      name :string\\l\\
      type :string\\l\\
      material :string\\l\\
    }']
    
    'c14_dates' [shape=record, label='{c14_dates|\\
      lab_code :string\\l\\
      bp :integer\\l\\
      std :integer\\l\\
    }']

    'sites' -> 'graves' [label='1:m']
    'graves' -> 'artefacts' [label='1:m']
    'graves' -> 'individuals' [label='1:m']
    'graves' -> 'c14_dates' [label='1:m']
    
}", height=400, width=800)

my_dia
```
---
## Structure MiscoviceDB

### Primary and foreign keys

```{r echo=FALSE, message=F}
library(DiagrammeR)
my_dia <- DiagrammeR::grViz("
digraph models_diagram {
    rankdir='LR';
    graph[overlap=false, splines=true]
    'sites' [shape=record, label='{sites|\\
      id :integer\\l\\
      name :string\\l\\
      lat :float\\l\\
      lng :float\\l\\
    }']
    
    'graves' [shape=record, label='{graves|\\
      id :integer\\l\\
      site_id :integer\\l\\
      grave_number :string\\l\\
      depth :float\\l\\
      length :float\\l\\
      width :float\\l\\
      construction :text\\l\\
    }']
    
    'individuals' [shape=record, label='{individuals|\\
      id :integer\\l\\
      grave_id :integer\\l\\
      sex :string\\l\\
      age :float\\l\\
      orientation :float\\l\\
      completness :float\\l\\
    }']
    
    'artefacts' [shape=record, label='{artefacts|\\
      id :integer\\l\\
      grave_id :integer\\l\\
      name :string\\l\\
      type :string\\l\\
      material :string\\l\\
    }']
    
    'c14_dates' [shape=record, label='{c14_dates|\\
      id :integer\\l\\
      grave_id :integer\\l\\
      lab_code :string\\l\\
      bp :integer\\l\\
      std :integer\\l\\
    }']

    'sites' -> 'graves' [label='1:m']
    'graves' -> 'artefacts' [label='1:m']
    'graves' -> 'individuals' [label='1:m']
    'graves' -> 'c14_dates' [label='1:m']
    
}", height=400, width=800)

my_dia
```
---
## Structure MiscoviceDB

### Lookup tables

```{r echo=FALSE, message=F}
library(DiagrammeR)
my_dia <- DiagrammeR::grViz("
digraph models_diagram {
    rankdir='LR';
    graph[overlap=false, splines=true]
    'sites' [shape=record, label='{sites|\\
      id :integer\\l\\
      name :string\\l\\
      lat :float\\l\\
      lng :float\\l\\
    }']
    
    'graves' [shape=record, label='{graves|\\
      id :integer\\l\\
      site_id :integer\\l\\
      grave_number :string\\l\\
      depth :float\\l\\
      length :float\\l\\
      width :float\\l\\
      construction :text\\l\\
    }']
    
    'individuals' [shape=record, label='{individuals|\\
      id :integer\\l\\
      grave_id :integer\\l\\
      sex_id :integer\\l\\
      age :float\\l\\
      orientation :float\\l\\
      completness :float\\l\\
    }']
    
    'sexes' [shape=record, label='{sexes|\\
      id :integer\\l\\
      name :string\\l\\
    }']
    
    'artefacts' [shape=record, label='{artefacts|\\
      id :integer\\l\\
      grave_id :integer\\l\\
      name :string\\l\\
      type_id :integer\\l\\
      material_id :integer\\l\\
    }']
    
    'types' [shape=record, label='{types|\\
      id :integer\\l\\
      name :string\\l\\
    }']
    
    'materials' [shape=record, label='{materials|\\
      id :integer\\l\\
      name :string\\l\\
    }']
    
    'c14_dates' [shape=record, label='{c14_dates|\\
      id :integer\\l\\
      grave_id :integer\\l\\
      lab_code :string\\l\\
      bp :integer\\l\\
      std :integer\\l\\
    }']

    'sites' -> 'graves' [label='1:m']
    'graves' -> 'artefacts' [label='1:m']
    'graves' -> 'individuals' [label='1:m']
    'graves' -> 'c14_dates' [label='1:m']
    'types' -> 'artefacts' [label='1:m']
    'materials' -> 'artefacts' [label='1:m']
    'sexes' -> 'individuals' [label='1:m']
    
}", height=400, width=800)

my_dia
```
---
## Tables

---
## Relationsships

---
## Forms

---
## Data Entry

---
## Queries

---
class: inverse, middle, center
# Any questions?

.footnote[
.right[
.tiny[
You might find the course material (including the presentations) at

https://github.com/MartinHinz/ca_hs_2019

You can see the rendered presentations at

http://martinhinz.github.io/ca_hs_2019

You can contact me at

<a href="mailto:martin.hinz@iaw.unibe.ch">martin.hinz@iaw.unibe.ch</a>

Sources for the slides:

'Introduction to Database Systems' (Hellerstein/Olston 2005)
'Introduction to Database Development' (Paterson)
]
]
]
